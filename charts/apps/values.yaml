applications:

  - name: redis
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: base-apps
    source:
      repoURL: registry-1.docker.io/bitnamicharts
      targetRevision: 24.0.0
      chart: redis
      helm:
        releaseName: redis
        valuesObject:
          global:
            defaultStorageClass: linode-block-storage
          auth:
            enabled: false
          image:
            repository: bitnamilegacy/redis
          architecture: replication
          replica:
            replicaCount: 1
    destination:
      namespace: redis-system
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: eg
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://docker.io/envoyproxy/gateway-helm
      targetRevision: v1.7.0
      path: .
      helm:
        releaseName: eg
        valuesObject:
          hpa:
            enabled: true
            minReplicas: 1
            maxReplicas: 2
          config:
            envoyGateway:
              gateway:
                controllerName: gateway.envoyproxy.io/gatewayclass-controller
              logging:
                level:
                  default: info
              rateLimit:
                backend:
                  type: Redis
                  redis:
                    # Update this URL to match your Redis service location
                    # This assumes Redis is deployed using the redis.yaml in this directory
                    url: redis-master.redis-system.svc.cluster.local:6379
              provider:
                type: Kubernetes
                kubernetes:
                  rateLimitDeployment:
                    patch:
                      type: StrategicMerge
                      value:
                        spec:
                          template:
                            spec:
                              containers:
                                - imagePullPolicy: IfNotPresent
                                  name: envoy-ratelimit
                                  image: docker.io/envoyproxy/ratelimit:60d8e81b
              extensionApis:
                # Not strictly required, but recommended for backward/future compatibility.
                enableEnvoyPatchPolicy: true
                # Required: Enable Backend API for AI service backends.
                enableBackend: true
              # Required: AI Gateway needs to fine-tune xDS resources generated by Envoy Gateway.
              extensionManager:
                #backendResources:
                #  - group: inference.networking.k8s.io
                #    kind: InferencePool
                #    version: v1
                hooks:
                  xdsTranslator:
                    translation:
                      listener:
                        includeAll: true
                      route:
                        includeAll: true
                      cluster:
                        includeAll: true
                      secret:
                        includeAll: true
                    post:
                      - Translation
                      - Cluster
                      - Route
                service:
                  fqdn:
                    # IMPORTANT: Update this to match your AI Gateway controller service
                    # Format: <service-name>.<namespace>.svc.cluster.local
                    # Default if you followed the installation steps above:
                    hostname: ai-gateway-controller.envoy-ai-gateway-system.svc.cluster.local
                    port: 1063
    destination:
      namespace: envoy-gateway-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: aieg-crd
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://docker.io/envoyproxy/ai-gateway-crds-helm
      targetRevision: v0.5.0
      path: .
      helm:
        releaseName: aieg-crd
    destination:
      namespace: envoy-ai-gateway-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: aieg
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://docker.io/envoyproxy/ai-gateway-helm
      targetRevision: v0.5.0
      path: .
      helm:
        releaseName: aieg
        valuesObject:
          controller:
            mutatingWebhook:
              certManager:
                enable: true
                # The name of the issuer.
                issuerName: self-signed-ca
                # The name of the certificate.
                certificateName: self-signed-cert-for-mutating-webhook-managed
          extProc:
            extraEnvVars:
                - name: OTEL_EXPORTER_OTLP_ENDPOINT
                  value: "http://phoenix-svc.converse-phoenix:6006"
                - name: OTEL_METRICS_EXPORTER
                  value: "none"
                - name: OTEL_EXPORTER_OTLP_HEADERS
                  value: 'Authorization=Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJBcGlLZXk6MTMifQ.wqPlCASB3JeDJPuxRMtCoQypQ_b6f45oUKtBhelLtEI'
    destination:
      namespace: envoy-ai-gateway-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: phoenix
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://registry-1.docker.io/arizephoenix/phoenix-helm
      targetRevision: 4.0.36
      path: .
      helm:
        releaseName: phoenix
        valuesObject:
          persistence:
            storageClass: linode-block-storage
          service:
            type: "ClusterIP"
          ingress:
            host: "analytics.ai.camer.digital"
            annotations:
              cert-manager.io/cluster-issuer: cert-home-cert-http
            tls:
              enabled: true
          additionalEnv:
            - name: PHOENIX_OAUTH2_KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: converse-phoenix-keycloak
                  key: client_secret
          auth:
            disableBasicAuth: true
            useSecureCookies: true
            createSecret: false
            name: "converse-phoenix"
            oauth2:
              enabled: true
              providers:
                keycloak:
                  client_id: "phoenix"
                  #client_secret: "your-keycloak-client-secret"
                  oidc_config_url: "https://accounts.ssegning.com/realms/camer-digital/.well-known/openid-configuration"
                  display_name: "CDigital"
                  allow_sign_up: true
                  auto_login: true
                  # Advanced: Extract roles from nested Keycloak structure
                  #groups_attribute_path: "resource_access.phoenix.roles"
                  #allowed_groups: ["admin", "developer", "viewer"]
                  # Advanced: Role mapping - map IDP roles to Phoenix roles (ADMIN, MEMBER, VIEWER)
                  role_attribute_path: "phoenix_role"  # JMESPath to extract role
                  role_mapping: "admin:ADMIN,user:MEMBER,viewer:VIEWER"  # Map IDP roles to Phoenix roles
                  role_attribute_strict: true  # If true, deny access when role cannot be determined
                  use_pkce: true
                  scopes: "openid phoenix"

    destination:
      namespace: converse-phoenix
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: authorino-operator
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: https://kuadrant.io/helm-charts
      targetRevision: 0.22.0
      chart: authorino-operator
      helm:
        releaseName: authorino-operator
    destination:
      namespace: authorino-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: secrets
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/whythatfunction/home-ai-secrets.git
      targetRevision: HEAD
      path: manifests
    destination:
      namespace: manifests
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-auth
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/whythatfunction/home-ai
      targetRevision: HEAD
      path: manifests/converse-auth
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-mcp
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/whythatfunction/home-ai
      targetRevision: HEAD
      path: manifests/converse-mcp
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-llm-core
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/ai-helm
      targetRevision: feat/observability
      path: charts/ai-gateway-core
      helm:
        releaseName: converse-core
        valuesObject:
          envoy:
            namespace: "converse-llm"
          tls:
            enabled: true
            domains:
              - converse-llm.camer.digital
              - api.ai.camer.digital
            secretName: converse-llm-tls
            issuer:
              create: false
              kind: ClusterIssuer
              name: cert-home-cert-http
            redirectToHttps: true
          envoyProxy:
#            logging:
#              level:
#                default: debug
            provider:
              type: Kubernetes
              kubernetes:
                envoyDeployment:
                  replicas: 2
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-llm-models
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/ai-helm
      targetRevision: HEAD
      path: charts/models
      helm:
        releaseName: converse-models
        valuesObject: { }
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true
